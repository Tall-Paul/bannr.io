function show_editor(){$(".main-panel").removeClass("col-lg-12").addClass("col-lg-8"),$(".side-panel").removeClass("col-lg-0").addClass("col-lg-4"),$(".editor_hidden").show()}function hide_editor(){$(".main-panel").removeClass("col-lg-8").addClass("col-lg-12"),$(".side-panel").removeClass("col-lg-4").addClass("col-lg-0"),$(".editor_hidden").hide()}var editorAPI=editorAPI||{};editorAPI.init=function(){this.loadedSites=null,this.loadedTemplates=null,this.loadedCampaigns=null,this.loadedSchedules=null,this.uploadOptions={success:editorAPI.fileUploaded,dataType:"json"}},editorAPI.afterFormRender=function(){$(".spectrum").spectrum({preferredFormat:"name"}),$(".spectrum").show()},editorAPI.fileUploaded=function(e){var t=e.filename,a=e.target;$("#"+a).val(t)},editorAPI.parseDataElements=function(e){dataElements=matchHTML(e),returnArray=[];for(var t=0;t<dataElements.length;t++){var a=new Object;a.name=dataElements[t],a.type="text",e.indexOf("color:{{"+a.name+"}}")>-1&&(a.type="colour"),e.indexOf('src="{{'+a.name+"}}")>-1&&(a.type="file"),returnArray.push(a)}return returnArray},editorAPI.renderFormElement=function(e,t,a){switch(el="",a){case"colour":el+="  <div class='rowElem spectrum'><label for='"+t+"'>"+t+": </label>",el+="<input type='text' class='template_editor_data_input spectrum' data-inputname='"+t+"' id='"+e+"' value='placeholder' name='"+t+"' /></div>";break;case"file":el+="  <div class='rowElem negPad'><label for='"+t+"'>"+t+": </label>",el+="<form class='form-horizontal' id='form_"+e+"' enctype='multipart/form-data' method='post' action='/api/sites/"+$(scheduleBuilder.editorSitesID).val()+"/images' autocomplete='off'>",el+="<input type='hidden' name='_token' value='"+$("#_token").val()+"' />",el+="<input type='hidden' name='file_target' value='"+e+"' />",el+="<input type='text' class='filename template_editor_data_input' data-inputname='"+t+"' id='"+e+"'/>",el+="<div class='fileUpload btn btn-primary'>",el+="<span>Upload</span>",el+="<input type='file' class='upload ' name='image' id='upload_"+e+"' />",el+="</div>",el+="</form></div>",el+="<script>",el+="$('body').delegate('#upload_"+e+"','change', function(){ $('#form_"+e+"').ajaxForm(editorAPI.uploadOptions).submit(); });",el+="</script>";break;default:el+="  <div class='rowElem'><label for='"+t+"'>"+t+": </label>",el+="<input type='text' class='template_editor_data_input' data-inputname='"+t+"' id='"+e+"' value='placeholder' name='"+t+"' /></div>"}return el},editorAPI.deleteTemplate=function(e,t,a){var i="/api/sites/"+e+"/templates/"+t,d={_token:$("#_token").val(),"delete":"true"};$.post(i,d,function(e){editorAPI.loadedTemplates=null,a(e)})},editorAPI.deleteCampaign=function(e,t,a){var i="/api/sites/"+e+"/campaigns/"+t,d={_token:$("#_token").val(),"delete":"true"};$.post(i,d,function(e){editorAPI.loadedCampaigns=null,a(e)})},editorAPI.deleteSchedule=function(e,t,a){var i="/api/sites/"+e+"/schedules/"+t,d={_token:$("#_token").val(),"delete":"true"};$.post(i,d,function(e){editorAPI.loadedSchedules=null,a(e)})},editorAPI.returnSites=function(e){e(editorAPI.loadedSites)},editorAPI.returnTemplates=function(e){e(editorAPI.loadedTemplates)},editorAPI.returnTemplate=function(e,t){$.each(editorAPI.loadedTemplates,function(a,i,d){e==i.id&&t(i)})},editorAPI.returnSchedule=function(e,t){$.each(editorAPI.loadedSchedules,function(a,i,d){e==i.id&&t(i)})},editorAPI.returnCampaign=function(e,t){$.each(editorAPI.loadedCampaigns,function(a,i,d){e==i.id&&t(i)})},editorAPI.returnTemplateWithData=function(e,t,a){$.each(editorAPI.loadedTemplates,function(i,d,l){e==d.id&&(d.data=t,a(d))})},editorAPI.saveCampaign=function(e,t,a,i){var d="/api/sites/"+e+"/campaigns/"+t;$.post(d,a,function(e){editorAPI.loadedCampaigns=null,i(e)})},editorAPI.saveSchedule=function(e,t,a,i){var d="/api/sites/"+e+"/schedules/"+t;$.post(d,a,function(e){editorAPI.loadedSchedules=null,i(e)})},editorAPI.loadSites=function(e){null===editorAPI.loadedSites?$.getJSON("/api/sites",function(t){var a="";$.each(t,function(e,t){a+="<option value='"+t.id+"' >"+t.label+"</option>"}),editorAPI.loadedSites=a,editorAPI.returnSites(e)}):editorAPI.returnSites(e)},editorAPI.saveTemplate=function(e,t,a,i){var d="/api/sites/"+e+"/templates/"+t;$.post(d,a,function(e){editorAPI.loadedTemplates=null,i(e)})},editorAPI.loadTemplates=function(e,t){$.getJSON("/api/sites/"+e+"/templates",function(e){editorAPI.loadedTemplates=e,editorAPI.returnTemplates(t)})},editorAPI.loadTemplate=function(e,t,a){null===editorAPI.loadedTemplates?$.getJSON("/api/sites/"+e+"/templates",function(e){editorAPI.loadedTemplates=e,editorAPI.returnTemplate(t,a)}):editorAPI.returnTemplate(t,a)},editorAPI.returnCampaigns=function(e){e(editorAPI.loadedCampaigns)},editorAPI.loadCampaigns=function(e,t){null===editorAPI.loadedCampaigns?$.getJSON("/api/sites/"+e+"/campaigns",function(e){editorAPI.loadedCampaigns=e,editorAPI.returnCampaigns(t)}):editorAPI.returnCampaigns(t)},editorAPI.returnSchedules=function(e){e(editorAPI.loadedSchedules)},editorAPI.loadSchedules=function(e,t){null===editorAPI.loadedSchedules?$.getJSON("/api/sites/"+e+"/schedules",function(e){editorAPI.loadedSchedules=e,editorAPI.returnSchedules(t)}):editorAPI.returnSchedules(t)},editorAPI.loadTemplateWithData=function(e,t,a,i){null===editorAPI.loadedTemplates?$.getJSON("/api/sites/"+e+"/templates",function(e){editorAPI.loadedTemplates=e,editorAPI.returnTemplateWithData(t,a,i)}):editorAPI.returnTemplateWithData(t,a,i)},editorAPI.loadCampaign=function(e,t,a){null===editorAPI.loadedCampaigns?$.getJSON("/api/sites/"+e+"/campaigns",function(e){editorAPI.loadedCampaigns=e,editorAPI.returnCampaign(t,a)}):editorAPI.returnCampaign(t,a)},editorAPI.loadSchedule=function(e,t,a){null===editorAPI.loadedSchedules?$.getJSON("/api/sites/"+e+"/schedules",function(e){editorAPI.loadedSchedules=e,editorAPI.returnSchedule(t,a)}):editorAPI.returnSchedule(t,a)},editorAPI.loadLive=function(e,t,a){$.ajax({dataType:"json",url:"/api/sites/"+e+"/schedules/live/"+encodeURIComponent(t),beforeSend:function(e){e.setRequestHeader("CF-IPCountry",$("#live_preview_country").val()),e.setRequestHeader("Preview-IPCountry",$("#live_preview_country").val())},success:function(e){a(e)}})},editorAPI.encodeString=function(e){return Base64.encode(e)},editorAPI.decodeString=function(e){return Base64.decode(e)};var templateBuilder=templateBuilder||{};templateBuilder.init=function(){this.editorSitesID="#editor_siteid",this.editorTemplatesID="#template_editor_template",this.editorNameID="#template_editor_name",this.editorHtmlID="#template_editor_html",this.editorJsID="#template_editor_javascript",this.editorTargetID="#template_editor_target",this.editorInjectID="#template_editor_inject",this.editorInputClass=".template_editor_data_input",this.editorInputContainerID="#template_editor_data_inputs",this.editorPreviewButtonID="#template_preview_button",this.editorSaveButtonID="#template_save_button",this.editorDeleteButtonID="#template_delete_button",window.addEventListener("message",function(e){switch(e.data.message){case"div_selected":jQuery(templateBuilder.editorHtmlID).val(beautify_html(e.data.html)),jQuery(templateBuilder.editorTargetID).val(e.data.target),show_editor()}},!1),$(templateBuilder.editorSaveButtonID).click(function(){templateBuilder.saveData()}),$(templateBuilder.editorDeleteButtonID).click(function(){templateBuilder.deleteTemplate()}),$(templateBuilder.editorPreviewButtonID).click(function(){templateBuilder.getData()}),$(templateBuilder.editorHtmlID).change(function(){templateBuilder.renderForm()}),$(templateBuilder.editorJsID).change(function(){templateBuilder.renderForm()}),$(templateBuilder.editorTargetID).change(function(){targetFrame=document.getElementById("preview"),targetFrame.contentWindow.postMessage({message:"target_change",target:$(templateBuilder.editorTargetID).val()},"*")}),$(templateBuilder.editorSitesID).change(function(){templateBuilder.loadTemplates()}),$(templateBuilder.editorTemplatesID).change(function(){templateBuilder.loadTemplate()}),templateBuilder.loadTemplates()},templateBuilder.reInit=function(){templateBuilder.reset(),templateBuilder.loadTemplates()},templateBuilder.reset=function(){$(templateBuilder.editorNameID).val(""),$(templateBuilder.editorHtmlID).val(""),$(templateBuilder.editorTargetID).val(""),$(templateBuilder.editorInjectID).val(""),$(templateBuilder.editorJsID).val(""),$(templateBuilder.editorInputContainerID).html(" ")},templateBuilder.renderForm=function(){str=$(templateBuilder.editorHtmlID).val(),js=$(templateBuilder.editorJsID).val(),placeholders=editorAPI.parseDataElements(str+" "+js),$(templateBuilder.editorInputContainerID).html("");for(var e="",t=0;t<placeholders.length;t++){var a=placeholders[t];e+=editorAPI.renderFormElement(a.name,a.name,a.type)}$(templateBuilder.editorInputContainerID).append(e),editorAPI.afterFormRender()},templateBuilder.deleteTemplate=function(){editorAPI.deleteTemplate($(templateBuilder.editorSitesID).val(),$(templateBuilder.editorTemplatesID).val(),templateBuilder.savedTemplate)},templateBuilder.saveData=function(){return""==$(templateBuilder.editorNameID).val()?(alert("please enter a name for this template!!"),!1):(html=$(templateBuilder.editorHtmlID).val(),html=editorAPI.encodeString(html),js=$(templateBuilder.editorJsID).val(),js=editorAPI.encodeString(js),datstr='{"name":"'+$(templateBuilder.editorNameID).val().trim()+'",',datstr+='"_token":"'+$("#_token").val()+'",',datstr+='"target":"'+$(templateBuilder.editorTargetID).val()+'",',datstr+='"inject":"'+$(templateBuilder.editorInjectID).val()+'",',datstr+='"html":"'+html+'",',"new"!==$(templateBuilder.editorTemplatesID).val()&&(datstr+='"id":"'+$(templateBuilder.editorTemplatesID).val()+'",'),datstr+='"js":"'+js+'",',datstr+='"defaults":{',$(templateBuilder.editorInputClass).each(function(){datstr+='"'+$(this).attr("id")+'":"'+$(this).val()+'",'}),datstr=datstr.slice(0,-1),datstr+="}",datstr+="}",dat=JSON.parse(datstr),editorAPI.saveTemplate($(templateBuilder.editorSitesID).val(),$(templateBuilder.editorTemplatesID).val(),dat,templateBuilder.savedTemplate),void 0)},templateBuilder.savedTemplate=function(e){e=JSON.parse(e),"success"==e.status?(templateBuilder.reset(),templateBuilder.loadTemplates()):alert("Error saving data!!")},templateBuilder.getData=function(){if(""==$(templateBuilder.editorNameID).val())return alert("please enter a name for this template!!"),!1;datstr='[{"preview":',datstr+="{",datstr+='"template":"'+$(templateBuilder.editorNameID).val()+'",',$(templateBuilder.editorInputClass).each(function(){datstr+='"'+$(this).attr("id")+'":"'+$(this).val()+'",'}),datstr+='"javascript":"'+editorAPI.encodeString($(templateBuilder.editorJsID).val())+'"',datstr+="}",datstr+="}]",dat=JSON.parse(datstr),html="<div class='"+$(templateBuilder.editorNameID).val()+" preview_div' data-target='"+$(templateBuilder.editorTargetID).val()+"' data-inject='"+$(templateBuilder.editorInjectID).val()+"'>",html+=$(templateBuilder.editorHtmlID).val(),html+="</div>",targetFrame=document.getElementById("preview");var e={message:"template_preview",html:html,dat:dat};targetFrame.contentWindow.postMessage(e,"*")},templateBuilder.loadSites=function(){editorAPI.loadSites(templateBuilder.populateSites)},templateBuilder.populateSites=function(e){$(templateBuilder.editorSitesID).html(e),templateBuilder.loadTemplates()},templateBuilder.loadTemplates=function(){editorAPI.loadTemplates($(templateBuilder.editorSitesID).val(),templateBuilder.populateTemplates)},templateBuilder.populateTemplates=function(e){var t="";t+="<option value='new'>New...</option>",$.each(e,function(e,a){t+="<option value='"+a.id+"' >"+a.name+"</option>"}),$(templateBuilder.editorTemplatesID).html(t)},templateBuilder.loadTemplate=function(){var e=$(templateBuilder.editorTemplatesID).val();return"new"==e?void templateBuilder.reset():void editorAPI.loadTemplate($(templateBuilder.editorSitesID).val(),e,templateBuilder.populateTemplate)},templateBuilder.populateTemplate=function(e){$(templateBuilder.editorNameID).val(e.name),$(templateBuilder.editorTargetID).val(e.target),$(templateBuilder.editorInjectID).val(e.inject),$(templateBuilder.editorHtmlID).val(beautify_html(editorAPI.decodeString(e.html))),$(templateBuilder.editorJsID).val(editorAPI.decodeString(e.javascript)),templateBuilder.renderForm(),$.each(e["default"],function(e,t){$("#"+e).val(t)}),$(".spectrum").spectrum({preferredFormat:"name"}),$(".spectrum").show(),targetFrame=document.getElementById("preview"),targetFrame.contentWindow.postMessage({message:"target_change",target:$(templateBuilder.editorTargetID).val()},"*")};var campaignBuilder=campaignBuilder||{};campaignBuilder.init=function(){this.editorSitesID="#editor_siteid",this.editorCampaignID="#campaign_editor_campaign",this.editorTemplatesID="#campaign_editor_template",this.editorAddTemplateID="#campaign_editor_add_template",this.editorAccordionID="#campaign_editor_accordion",this.editorPreviewButtonID="#campaign_editor_preview_campaign",this.editorSaveButtonID="#campaign_save_button",this.editorNameID="#campaign_editor_name",this.editorDeleteButtonID="#campaign_delete_button",campaignBuilder.loadCampaigns(),$(this.editorAddTemplateID).click(function(){var e=$(campaignBuilder.editorTemplatesID).val();editorAPI.loadTemplate($(campaignBuilder.editorSitesID).val(),e,campaignBuilder.addTemplate)}),$(this.editorCampaignID).change(function(){campaignBuilder.loadCampaign()}),$(this.editorPreviewButtonID).click(function(){campaignBuilder.getPreviewData()}),$(this.editorSaveButtonID).click(function(){campaignBuilder.saveCampaign()}),$(this.editorDeleteButtonID).click(function(){campaignBuilder.deleteCampaign()})},campaignBuilder.deleteCampaign=function(){editorAPI.deleteCampaign($(campaignBuilder.editorSitesID).val(),$(campaignBuilder.editorCampaignID).val(),campaignBuilder.savedCampaign)},campaignBuilder.reInit=function(){$(campaignBuilder.editorAccordionID).html(" "),$(campaignBuilder.editorAccordionID).accordion().accordion("destroy"),$(campaignBuilder.editorNameID).val(""),campaignBuilder.loadCampaigns()},campaignBuilder.saveCampaign=function(){if(""==$(campaignBuilder.editorNameID).val())return alert("please enter a name for this campaign!!"),!1;var e='{"name":"'+$(campaignBuilder.editorNameID).val()+'",';e+='"_token":"'+$("#_token").val()+'",',e+='"templates":{',$(".campaign_editor_data_elements").each(function(){var t=$(this).data("templateid");e+='"template_'+t+'":{',$(this).find("input").each(function(){void 0!==$(this).data("inputname")&&(e+='"'+$(this).data("inputname")+'":"'+$(this).val()+'",')}),e=e.slice(0,-1),e+="},"}),e=e.slice(0,-1),e+="}}";var t=JSON.parse(e);editorAPI.saveCampaign($(campaignBuilder.editorSitesID).val(),$(campaignBuilder.editorCampaignID).val(),t,campaignBuilder.savedCampaign)},campaignBuilder.savedCampaign=function(e){e=JSON.parse(e),"success"==e.status?(campaignBuilder.reset(),campaignBuilder.loadCampaigns()):alert("Error saving data!!")},campaignBuilder.getPreviewData=function(){var e="";datstr="[",$(".campaign_editor_data_elements").each(function(){var t=$(this).data("templatename"),a=$(this).data("target"),i=$(this).data("inject");e+="<div class='"+t+" preview_div' data-target='"+a+"' data-inject='"+i+"'>";var d=$(this).children("textarea.html_textarea").html(),l=editorAPI.encodeString($(this).children("textarea.js_textarea").val());d=jQuery("<div/>").html(d).text(),e+=d,e+="</div>",datstr+='{"preview":',datstr+="{",datstr+='"template" : "'+t+'",',$(this).find("input").each(function(){void 0!==$(this).data("inputname")&&(datstr+='"'+$(this).data("inputname")+'":"'+$(this).val()+'",')}),datstr+='"javascript":"'+l+'"',datstr+="}",datstr+="},"}),datstr=datstr.slice(0,-1),datstr+="]",dat=JSON.parse(datstr),targetFrame=document.getElementById("preview");var t={message:"template_preview",html:e,dat:dat};targetFrame.contentWindow.postMessage(t,"*")},campaignBuilder.reset=function(){$(campaignBuilder.editorAccordionID).html(" "),$(campaignBuilder.editorAccordionID).accordion("destroy"),campaignBuilder.loadTemplates()},campaignBuilder.addTemplate=function(e){void 0==e.data||null==e.data?data=e["default"]:data=e.data;var t=e.name,a=e.id,i=editorAPI.decodeString(e.html),d=editorAPI.decodeString(e.javascript),l=editorAPI.parseDataElements(i+" "+d);el="<h3>"+t+"</h3>",el+="<div class='campaign_editor_data_elements' data-templatename='"+t+"' data-templateid='"+a+"' data-target='"+e.target+"' data-inject='"+e.inject+"'>";var r="campaign_input_"+t+"_html",n="campaign_input_"+t+"_js";el+="<textarea id='"+r+"' style='display:none' class='html_textarea'>"+i+"</textarea>",el+="<textarea id='"+n+"' style='display:none' class='js_textarea'>"+d+"</textarea>";for(var o=0;o<l.length;o++){var u=l[o],s="campaign_input_"+t+"_"+u.name;el+=editorAPI.renderFormElement(s,u.name,u.type)}el+="</div>",$(campaignBuilder.editorAccordionID).append(el),$(campaignBuilder.editorAccordionID).accordion().accordion("destroy").accordion(),$.each(data,function(e,a){$("#campaign_input_"+t+"_"+e).val(a)}),editorAPI.afterFormRender()},campaignBuilder.loadSites=function(){editorAPI.loadSites(campaignBuilder.populateSites)},campaignBuilder.populateSites=function(e){$(campaignBuilder.editorSitesID).html(e),campaignBuilder.loadCampaigns()},campaignBuilder.loadCampaigns=function(){editorAPI.loadCampaigns($(campaignBuilder.editorSitesID).val(),campaignBuilder.populateCampaigns)},campaignBuilder.populateCampaigns=function(e){var t="";t+="<option value='new'>New...</option>",$.each(e,function(e,a){t+="<option value='"+a.id+"' >"+a.name+"</option>"}),$(campaignBuilder.editorCampaignID).html(t),campaignBuilder.loadTemplates()},campaignBuilder.loadTemplates=function(){editorAPI.loadTemplates($(campaignBuilder.editorSitesID).val(),campaignBuilder.populateTemplates)},campaignBuilder.populateTemplates=function(e){var t="";t+="<option value=''>Select...</option>",$.each(e,function(e,a){t+="<option value='"+a.id+"' >"+a.name+"</option>"}),$(campaignBuilder.editorTemplatesID).html(t),$(campaignBuilder.editorAccordionID).accordion()},campaignBuilder.loadCampaign=function(){campaignBuilder.reset(),"new"!=$(campaignBuilder.editorCampaignID).val()&&editorAPI.loadCampaign($(campaignBuilder.editorSiteID).val(),$(this.editorCampaignID).val(),campaignBuilder.populateCampaign)},campaignBuilder.populateCampaign=function(data){var templates=data.templates,inject_data=JSON.parse(data.data);$(campaignBuilder.editorNameID).val(data.name),$.each(templates,function(el,index,arr){var dat=eval("inject_data.template_"+index.id);editorAPI.loadTemplateWithData($(campaignBuilder.editorSitesID).val(),index.id,dat,campaignBuilder.addTemplate)})};var scheduleBuilder=scheduleBuilder||{},schedule_campaigns=[];scheduleBuilder.init=function(){this.editorSitesID="#editor_siteid",this.editorSchedulesID="#schedule_editor_schedule",this.editorNameID="#schedule_editor_name",this.editorStartID="#schedule_editor_start",this.editorFinishID="#schedule_editor_finish",this.editorGeoID="#schedule_editor_geo",this.editorCampaignsID="#schedule_editor_campaigns",this.editorPreviewButtonID="#schedule_editor_preview_schedule",this.editorAddScheduleID="#schedule_editor_add_campaign",this.editorSaveButtonID="#schedule_save_button",this.editorAccordionID="#schedule_editor_accordion",this.editorDeleteButtonID="#schedule_delete_button",this.livePreviewButtonID="#live_preview_schedule",this.liveTimer=window.setTimeout(scheduleBuilder.loadLive,500),scheduleBuilder.loadSchedules(),scheduleBuilder.loadCampaigns(),schedule_campaigns=[],$(this.editorAddScheduleID).click(function(){var e=$(scheduleBuilder.editorCampaignsID).val();editorAPI.loadCampaign($(scheduleBuilder.editorSitesID).val(),e,scheduleBuilder.addCampaign)}),$(this.editorSchedulesID).change(function(){scheduleBuilder.loadSchedule()}),$(this.editorPreviewButtonID).click(function(){scheduleBuilder.getPreviewData()}),$("#live_preview_time").on("dp.change",function(){clearTimeout(scheduleBuilder.liveTimer),scheduleBuilder.liveTimer=window.setTimeout(scheduleBuilder.loadLive,500)}),$("#live_preview_country").change(function(){clearTimeout(scheduleBuilder.liveTimer),scheduleBuilder.liveTimer=window.setTimeout(scheduleBuilder.loadLive,500)}),$(this.editorSaveButtonID).click(function(){scheduleBuilder.saveSchedule()}),$(this.editorDeleteButtonID).click(function(){scheduleBuilder.deleteSchedule()})},scheduleBuilder.setLive=function(){$("#live_preview_time").data("DateTimePicker").date(moment().format("DD-MM-YYYY HH:mm"))},scheduleBuilder.populateLiveSchedule=function(){$(scheduleBuilder.editorSchedulesID).val($("#live_schedule_id").val()),scheduleBuilder.loadSchedule()},scheduleBuilder.liveEdit=function(){$('#editorTabs a[href="#schedule"]').tab("show"),scheduleBuilder.populateLiveSchedule()},scheduleBuilder.livePreview=function(){scheduleBuilder.populateLiveSchedule(),scheduleBuilder.getPreviewData()},scheduleBuilder.updateLive=function(e){$("#live_schedule_target").html("");var t="";void 0!==e.name?(t+="<input type='text' style='display:none' value='"+e.id+"' id='live_schedule_id' >",t+="<span>"+e.name+" expires at "+e.expire+"</span>",t+="<div class='live_schedule_buttons'><button type='button' class='btn btn-primary' id='live_schedule_preview'>Preview</button>&nbsp;<button type='button' class= 'btn btn-primary' id='live_schedule_edit'>Edit Schedule</button></div>"):t+="<span>No Schedule Defined</span>",$("#live_schedule_target").html(t),$("#live_schedule_preview").click(function(){scheduleBuilder.livePreview()}),$("#live_schedule_edit").click(function(){scheduleBuilder.liveEdit()})},scheduleBuilder.loadLive=function(){editorAPI.loadLive($(scheduleBuilder.editorSitesID).val(),$("#live_preview_time").data("DateTimePicker").date().format("DD-MM-YYYY HH:mm"),scheduleBuilder.updateLive)},scheduleBuilder.reInit=function(){scheduleBuilder.reset(),$(scheduleBuilder.editorAccordionID).html(" "),$(scheduleBuilder.editorAccordionID).accordion().accordion("destroy"),scheduleBuilder.loadSchedules(),scheduleBuilder.loadCampaigns(),$(".datetimepicker").datetimepicker({format:"DD/MM/YYYY HH:mm"}),schedule_campaigns=[]},scheduleBuilder.addTemplate=function(e){void 0==e.data||null==e.data?data=e["default"]:data=e.data;var t=e.name,a=e.id;if(!$("#schedule_template_container_"+a).length){var i=editorAPI.decodeString(e.html),d=editorAPI.decodeString(e.javascript),l=editorAPI.parseDataElements(i+" "+d);el="<h3>"+t+"</h3>",el+="<div id='schedule_template_container_"+a+"' class='schedule_editor_data_elements' data-templatename='"+t+"' data-templateid='"+a+"' data-target='"+e.target+"' data-inject='"+e.inject+"'>";var r="schedule_input_"+t+"_html",n="schedule_input_"+t+"_js";el+="<textarea id='"+r+"' style='display:none' class='html_textarea'>"+i+"</textarea>",el+="<textarea id='"+n+"' style='display:none' class='js_textarea'>"+d+"</textarea>";for(var o=0;o<l.length;o++){var u=l[o],s="schedule_input_"+t+"_"+u.name;el+=editorAPI.renderFormElement(s,u.name,u.type)}el+="</div>",$(scheduleBuilder.editorAccordionID).append(el),$(scheduleBuilder.editorAccordionID).accordion().accordion("destroy").accordion()}$.each(data,function(e,a){$("#schedule_input_"+t+"_"+e).val(a)}),editorAPI.afterFormRender()},scheduleBuilder.addCampaign=function(data){var templates=data.templates,inject_data=JSON.parse(data.data);schedule_campaigns.push(data.id),$.each(templates,function(el,index,arr){var dat=eval("inject_data.template_"+index.id);editorAPI.loadTemplateWithData($(scheduleBuilder.editorSitesID).val(),index.id,dat,scheduleBuilder.addTemplate)})},scheduleBuilder.deleteSchedule=function(e){editorAPI.deleteSchedule($(scheduleBuilder.editorSitesID).val(),$(scheduleBuilder.editorSchedulesID).val(),scheduleBuilder.savedSchedule)},scheduleBuilder.loadCampaigns=function(){editorAPI.loadCampaigns($(scheduleBuilder.editorSitesID).val(),scheduleBuilder.populateCampaigns)},scheduleBuilder.loadSchedules=function(){editorAPI.loadSchedules($(scheduleBuilder.editorSitesID).val(),scheduleBuilder.populateSchedules)},scheduleBuilder.populateCampaigns=function(e){var t="";t+="<option value='select'>Select...</option>",$.each(e,function(e,a){t+="<option value='"+a.id+"' >"+a.name+"</option>"}),$(scheduleBuilder.editorCampaignsID).html(t)},scheduleBuilder.populateSchedules=function(e){var t="";t+="<option value='new'>New...</option>",$.each(e,function(e,a){t+="<option value='"+a.id+"' >"+a.name+"</option>"}),$(scheduleBuilder.editorSchedulesID).html(t),$(scheduleBuilder.editorScheduleID).accordion()},scheduleBuilder.getPreviewData=function(){var e="";datstr="[",$(".schedule_editor_data_elements").each(function(){var t=$(this).data("templatename"),a=$(this).data("target"),i=$(this).data("inject");e+="<div class='"+t+" preview_div' data-target='"+a+"' data-inject='"+i+"'>";var d=$(this).children("textarea.html_textarea").html(),l=editorAPI.encodeString($(this).children("textarea.js_textarea").val());d=jQuery("<div/>").html(d).text(),e+=d,e+="</div>",datstr+='{"preview":',datstr+="{",datstr+='"template" : "'+t+'",',$(this).find("input").each(function(){void 0!==$(this).data("inputname")&&(datstr+='"'+$(this).data("inputname")+'":"'+$(this).val()+'",')}),datstr+='"javascript":"'+l+'"',datstr+="}",datstr+="},"}),datstr=datstr.slice(0,-1),datstr+="]",dat=JSON.parse(datstr),targetFrame=document.getElementById("preview");var t={message:"template_preview",html:e,dat:dat};targetFrame.contentWindow.postMessage(t,"*")},scheduleBuilder.saveSchedule=function(){if(""==$(scheduleBuilder.editorNameID).val())return alert("please enter a name for this campaign!!"),!1;var returnData={};returnData.name=$(scheduleBuilder.editorNameID).val(),returnData.campaigns=schedule_campaigns,returnData._token=$("#_token").val(),returnData.begin=$(scheduleBuilder.editorStartID).val(),returnData.finish=$(scheduleBuilder.editorFinishID).val(),returnData.geo=$(scheduleBuilder.editorGeoID).val(),returnData.templates={},$(".schedule_editor_data_elements").each(function(){var template_data={};$(this).find("input").each(function(){void 0!==$(this).data("inputname")&&eval("template_data."+$(this).data("inputname")+" = '"+$(this).val()+"';")}),eval("returnData.templates.template_"+$(this).data("templateid")+" = template_data;")}),editorAPI.saveSchedule($(scheduleBuilder.editorSitesID).val(),$(scheduleBuilder.editorSchedulesID).val(),returnData,scheduleBuilder.savedSchedule)},scheduleBuilder.savedSchedule=function(e){e=JSON.parse(e),"success"==e.status?(scheduleBuilder.reInit(),alert("schedule saved")):alert("Error saving data!!")},scheduleBuilder.reset=function(){$(scheduleBuilder.editorNameID).val(""),$(scheduleBuilder.editorStartID).val(""),$(scheduleBuilder.editorFinishID).val(""),$(scheduleBuilder.editorAccordionID).html(" "),$(scheduleBuilder.editorAccordionID).accordion().accordion("destroy")},scheduleBuilder.loadSchedule=function(){scheduleBuilder.reset(),"new"!=$(scheduleBuilder.editorSchedulesID).val()&&editorAPI.loadSchedule($(scheduleBuilder.editorSiteID).val(),$(scheduleBuilder.editorSchedulesID).val(),scheduleBuilder.populateSchedule)},scheduleBuilder.populateSchedule=function(e){$(scheduleBuilder.editorNameID).val(e.name),$(scheduleBuilder.editorStartID).val(e.start_at),$(scheduleBuilder.editorFinishID).val(e.finish_at),$(scheduleBuilder.editorGeoID).val(e.country_codes);var t=JSON.parse(e.data);$.each(e.campaigns,function(e,t,a){schedule_campaigns.push(t.id)}),$.each(t,function(e,t,a){var i=e.replace("template_","");editorAPI.loadTemplateWithData($(scheduleBuilder.editorSitesID).val(),i,t,scheduleBuilder.addTemplate)}),$(".datetimepicker").datetimepicker({format:"DD/MM/YYYY HH:mm"})};var i=0,dragging=!1;$(document).ready(function(){$("#editor_siteid").length&&($(".tabs").tabs(),$(".datetimepicker").datetimepicker({format:"DD/MM/YYYY HH:mm"}),$("#preview_url").change(function(){}),editorAPI.init(),templateBuilder.init(),campaignBuilder.init(),scheduleBuilder.init(),$("#live_preview_time").datetimepicker({inline:!0,sideBySide:!0,format:"DD-MM-YYYY HH:mm",useCurrent:!0}),$("#settings_save_button").click(function(){var e=$("#site_editor_name").val(),t=$("#site_editor_url").val(),a=$(scheduleBuilder.editorSitesID).val(),i=$("#_token").val();$.post("/api/sites/"+a,{name:e,url:t,_token:i},function(e){$("#preview").attr("src",function(e,t){return t})})}))}),$("#behaviour input").change(function(){targetFrame=document.getElementById("preview"),"select"==$("input[name=behaviour]:checked","#behaviour").val()?msg={message:"set_select"}:msg={message:"set_navigate"},targetFrame.contentWindow.postMessage(msg,"*")}),$("#show_editor").click(function(){show_editor()}),$("#hide_editor").click(function(){hide_editor()});